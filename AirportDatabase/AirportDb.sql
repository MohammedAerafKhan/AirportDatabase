CREATE DATABASE BTD210_Asg2_Grp7;

CREATE TABLE AIRLINES(
AIRLINE_CODE VARCHAR(10) PRIMARY KEY,
AIRLINE_NAME VARCHAR(20));

CREATE TABLE AIRCRAFT(
AIRCRAFT_CODE INT PRIMARY KEY,
AIRCRAFT_DESC VARCHAR(100));

CREATE TABLE AIRPORT(
AIRPORT_CODE VARCHAR(10) PRIMARY KEY,
AIRPORT_NAME VARCHAR(100),
AIRPORT_CITY VARCHAR(100)
);

CREATE TABLE FLIGHT(
FLIGHT_NUM VARCHAR(10) PRIMARY KEY,
AIRLINE_CODE VARCHAR(10),
AIRCRAFT_CODE  INT,
OPERATED_BY VARCHAR(10),
DEP_AIRPORT_CODE VARCHAR(10),
ARR_AIRPORT_CODE VARCHAR(10),
FOREIGN KEY (AIRLINE_CODE) REFERENCES AIRLINES(AIRLINE_CODE),
FOREIGN KEY (AIRCRAFT_CODE) REFERENCES AIRCRAFT(AIRCRAFT_CODE),
FOREIGN KEY (OPERATED_BY) REFERENCES AIRLINES(AIRLINE_CODE),
FOREIGN KEY (DEP_AIRPORT_CODE) REFERENCES AIRPORT(AIRPORT_CODE),
FOREIGN KEY (ARR_AIRPORT_CODE) REFERENCES AIRPORT(AIRPORT_CODE)
);

CREATE TABLE BOOKING(
BOOKING_ID INT,
BOOKED_ON DATE,
FLIGHT_NUM VARCHAR(10),
ROUTE_ID VARCHAR(10),
PRIMARY KEY(BOOKING_ID, FLIGHT_NUM),
FOREIGN KEY (ROUTE_ID) REFERENCES ROUTE(ROUTE_ID)
);


CREATE TABLE ROUTE(
ROUTE_ID VARCHAR(10),
FLIGHT_NUM VARCHAR(10),
DEP_DATE DATE,
DEP_TIME TIME,
ARR_DATE DATE,
ARR_TIME TIME,
FOREIGN KEY (FLIGHT_NUM) REFERENCES FLIGHT(FLIGHT_NUM),
PRIMARY KEY(ROUTE_ID,FLIGHT_NUM)
);

CREATE TABLE TRAVELER(
TRAVELER_ID INT PRIMARY KEY,
TRAVELER_FNAME VARCHAR(20),
TRAVELER_LNAME VARCHAR(20),
GENDER VARCHAR(20)
);

CREATE TABLE TICKET(
ETICKET_NUM DECIMAL(12) PRIMARY KEY,
TRAVELER_ID INT,
MEAL_PREFRENCES VARCHAR(100),
TICKET_PRICE DECIMAL(7,2),
TAXES_FEES DECIMAL(6,2),
BOOKING_ID INT,
FOREIGN KEY (TRAVELER_ID) REFERENCES TRAVELER(TRAVELER_ID),
FOREIGN KEY (BOOKING_ID) REFERENCES BOOKING(BOOKING_ID)
);


INSERT INTO BOOKING VALUES (56753365, '2019-01-28', 'AF393', '1');
INSERT INTO BOOKING VALUES (56753365, '2019-01-28', 'AF5106', '2');
INSERT INTO BOOKING VALUES (56753936, '2019-01-25', 'AF393', '1');
INSERT INTO BOOKING VALUES (56753936, '2019-01-25', 'AF386', '3');

INSERT INTO AIRCRAFT VALUES (772, 'BOEING 777 285-305 STD');
INSERT INTO AIRCRAFT VALUES (332, 'AIRBUS INDUSTRIE JET 200-345 STD');

INSERT INTO AIRLINES VALUES ('AF', 'AIR FRANCE');
INSERT INTO AIRLINES VALUES ('MEA', NULL);

INSERT INTO AIRPORT VALUES ('YYZ', 'Toronto Pearson Intl', 'Toronto');
INSERT INTO AIRPORT VALUES ('CDG', 'Charles de Gaul', 'Paris');
INSERT INTO AIRPORT VALUES ('BEY', NULL, 'Beirut');

INSERT INTO FLIGHT VALUES ('AF393', 'AF', 772, 'AF', 'YYZ', 'CDG');
INSERT INTO FLIGHT VALUES ('AF5106', 'AF', 332, 'MEA', 'CDG', 'BEY');
INSERT INTO FLIGHT VALUES ('AF386', 'AF', 772, 'AF', 'CDG', 'YYZ');

INSERT INTO ROUTE VALUES (1, 'AF393', '2019-06-22', '21:20:00', '2019-06-23', '10:50:00');
INSERT INTO ROUTE VALUES (2, 'AF5106', '2019-06-23', '13:40:00', '2019-06-23', '18:55:00');
INSERT INTO ROUTE VALUES (3, 'AF386', '2019-07-17', '17:00:00', '2019-09-17', '19:20:00');

INSERT INTO TRAVELER VALUES (111, 'Andrew', 'Smith', 'Male');
INSERT INTO TRAVELER VALUES (112, 'Mariam', 'Daoud', 'Female');
INSERT INTO TRAVELER VALUES (113, 'Yasmine', 'Ch', 'Female');
INSERT INTO TRAVELER VALUES (114, 'Hasan', 'Ch', 'Male');

INSERT INTO TICKET VALUES (573480996631, 111, 'Vegetarian', 1200, 182, 56753936);
INSERT INTO TICKET VALUES (573480996619, 112, 'Halal', 1353, 182, 56753365);
INSERT INTO TICKET VALUES (573480996620, 113, 'Vegetarian', 1142, 180, 56753365);
INSERT INTO TICKET VALUES (0573480996621, 114, 'Halal', 1142, 180, 56753365);

SELECT FLIGHT_NUM, A.AIRLINE_CODE, B.AIRLINE_NAME, A.AIRCRAFT_CODE, C.AIRCRAFT_DESC, A.DEP_AIRPORT_CODE, D.AIRPORT_NAME, A.ARR_AIRPORT_CODE, E.AIRPORT_NAME 
FROM FLIGHT A JOIN AIRLINES B ON A.AIRLINE_CODE = B.AIRLINE_CODE 
JOIN AIRCRAFT C ON A.AIRCRAFT_CODE = C.AIRCRAFT_CODE 
JOIN AIRPORT D ON A.DEP_AIRPORT_CODE = D.AIRPORT_CODE 
JOIN AIRPORT E ON A.ARR_AIRPORT_CODE = E.AIRPORT_CODE
WHERE FLIGHT_NUM = 'AF393';

SELECT A.BOOKING_ID, A.BOOKED_ON, A.FLIGHT_NUM, B.DEP_AIRPORT_CODE, C.DEP_DATE, C.DEP_TIME, B.ARR_AIRPORT_CODE, C.ARR_DATE, C.ARR_TIME
FROM BOOKING A JOIN FLIGHT B ON A.FLIGHT_NUM = B.FLIGHT_NUM
JOIN ROUTE C ON C.FLIGHT_NUM = B.FLIGHT_NUM
WHERE A.BOOKING_ID = '56753365'
ORDER BY DEP_DATE, DEP_TIME;

SELECT B.BOOKING_ID, B.ETICKET_NUM, A.TRAVELER_FNAME, A.TRAVELER_LNAME
FROM TRAVELER A JOIN TICKET B ON A.TRAVELER_ID = B.TRAVELER_ID
WHERE B.BOOKING_ID = '56753365';

SELECT SUM(TICKET_PRICE + TAXES_FEES) AS TOTAL_FEES FROM TICKET WHERE BOOKING_ID = '56753365';

SELECT BOOKING_ID, COUNT(ETICKET_NUM) 
FROM TICKET
GROUP BY BOOKING_ID;

SELECT BOOKING_ID, SUM(TICKET_PRICE + TAXES_FEES) AS TOTAL_FEES
FROM TICKET
GROUP BY BOOKING_ID;

SELECT BOOKING_ID, SUM(TICKET_PRICE + TAXES_FEES) AS TOTAL_FEES
FROM TICKET
GROUP BY BOOKING_ID
HAVING TOTAL_FEES > 1000;

CREATE VIEW BOOKINGFEES AS
SELECT BOOKING_ID, SUM(TICKET_PRICE + TAXES_FEES) AS TOTAL_FEES
FROM TICKET
GROUP BY BOOKING_ID;

SELECT BOOKING_ID, TOTAL_FEES
FROM BOOKINGFEES
WHERE TOTAL_FEES > 1000;



